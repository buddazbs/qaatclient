on:
  push:
    - workflows: build-workflow 
      filter: 
        branches: ["main"]

workflows:
  build-workflow:
    tasks:
      - build-task
      - deploy-task

tasks:
  - name: build-task
    env:
        IMAGE_URI: dockerhub_account/hello-world
    cubes:
      - name: docker-build
        script:
          - docker build . --file Dockerfile --tag $IMAGE_URI:$(date +%s)
  - name: deploy-task
    cubes:
      - name: build-site
        script:
          - chmod +x build-site.sh
          - ./build-site.sh
          - |
            if [ -n "$(git status --porcelain public)" ]; then
              git config --global user.email "ci@sourcecraft.dev"
              git config --global user.name "SourceCraft CI"
              git add public
              git commit -m "Update static site build [skip ci]"
            else
              echo "No changes in public folder"
            fi
      - name: push-changes
        script:
          - |
            if [ -n "$(git status --porcelain public)" ]; then
              git push origin main
            else
              echo "No changes to push"
            fi